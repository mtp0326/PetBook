<!DOCTYPE html>
<html>

<head>
  <link rel="icon" type="image/x-icon"
    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAADu1JREFUeF7tXXtwVNUZ/303+wggooAkI7ALQolKtYqPOsW2+geaCqKU0A6+RqvAhpn6fkDbmQydPhC1A1WTCxRlRitTgQFEKtQqrUJrEUGlBaThsQtUQgKEp7l3N/frnN1sCLDJ3rt7X7veM5O/8p3v+dtzz+M73yEUYQtO2jkMfl8FNBqqgcIEbQAB5Qz0AXABgPJOzD4AoJmAQwwcYGCfBIpC4nrEE18o84fsKDZ3UaEbVDp5Z0gj/0gmvoGAawFcBaC7RXadAvApAxuJ6SOJ4+tb5g2JWSTLFrYFCYDg1L2VmqZVEjAKwOW2eKpzIVsZeFeSpNVK7cDVDutiWHzBACBYvWc0M1WBcCc4OYy7sPFRQFpGJC1R6gascqGC56jkagAEq/dXMCfuJ6IHmfmiQnBoWkciamTmBUS+hUpd/y/cqrsrARCMxG5l1iIgutOtjjOkF/NyIklW5NAaQ/1sIHYVAAJTolUk4RFm3GiD7baLIMY6Jmm2Kg9carvwTgS6AgDBSHQMgGkMjHSLY6zUg4D1AGYqcvhtK+Xo4e0oAPyR/VcTWmsAvkOPssVHQysYJTPicv/NTtnmDABqWAo0xH4L4GmnDHeZ3FlqWWg6ZpBmt162AyBYHRvL0J4D0zC7jXW1PKIdBDyl1IXeslNPWwHgj0TnEPCwnQYWmiwGfh+Xw4/YpbctAPBPjV1HGssARthlWIHL2cQSReK1oY+ttsNyAPgj0UkEzLPakGLkz8DkuByeb6VtlgLAH9nzPIGesNKAYufN4Bfi8qAnrbLTGgDUsC/QEFsEoMoqxb9mfJeoZaGJmEEJs+02HQA9pu4uT7RKi5mKczfP7ADo5Sd2EX2lpVUn55Q16O2jh85UAAQnx4awhGUAX6FHuEdj1AO0hTSMU+aFdhrt2Rm9aQAIVu+qYC4RW5tDzVLO45PRA/VErWOUuktMOWE0BQCpXz6LZAgv+Pagtp40qjRjJMgbAD0eaSiLK8q73rBvT+RPS6Etfqn1lpO1g0UeY84tPwDUsC94ILbWm/Dl7P+8OoqJoVIeujmf1UFeAAhEoou9pV5eMTSj8xJVDk/IlVHOAPA2eXJ1ufn98tksygkA3vau+UHMl2Ou28aGAdB2sLMhX4W9/uZ7gCW63ugBkmEABCLRT7xTPfODZxLHTaocvsYIL0MA8M7zjbjWGVqj+QS6AZDM5GFe4YxZnlQjHiCiO/RmFukDgMjhO7h3G5i9NC4jkXCKlniH2i98mZ4cQ10ACESiz3oJnE5FM2e5s1Q5/Ey23lkBkErdTmzKxsj7v/s8wPCNyJZynhUAgUhs+dc3b999QTWmEa1Q5VCX1+u6BIC4scPASmNCPWo3eYCA27u6gZQNAOu+Lte13BQ0M3UR19AUOdzpXctOARCI7B0PaEvMVMbj5ZAHGBPUueGMsewUAMEp0Q+9Y16HAmayWCKsU+rC383ENiMAkvfzkczwcU0r9ROm3tQTld8sRYmUde6al94aA7sa4/j3/jg+3xfH1i/jaDzemhdPpzsTqDJTfYKMngxM2bPMbcUZegQJL07sjbu/3cMRX26MqnjjXyex+JNTOHisAMHAvFydO2jc2c47BwBtZVm2O+LlLoQ6DYC0asdbNLy89gRq/3YcDQUGBCLfpWeXqzkHAIFIVFzbnuYBoGsP7G5K4KeLDuP97S1otf1Sd87RmanK4ekde2cYAWIH3ViQyS0jQEfntcQZ05c1Y8GHJ6AkOOeo2NVRFK5S6kL9OgVAsHrfaOZWx8uWZHKIGwEg9Iy3MmasPIoX3z8OAQi3NyIeo9QNai9hd8YIEIjEXgX4fjca4VYACF+JeUHk9cNYtvlUIXwOFqpy+IF0jM8CwJ5mgHp5ADDuATEnmCA3Ysv+uPHOdvYgNKt14QvPAYAov8qa9o6duhiR5eYRIG3Hy2uP4xfLm3FKdfengCTpB+mytu0jgD8SnU2AbaVJjARf0BoFwPp6Be9tb4Gmc4YuScCwMh+GXxzA8Iv9yGWvqemEhh/NbYSQ7ebGwJy4HH5U6NgOgEAk+h8XFF7u1G9GAVDzVjOeW3Msp29yz1IJP7y6G352Wy8M6uszFMuZ7xzDb/581O2rgq2qHB7eDoBkyXXJFzVkqc3EdgIgbVr/C0sw+8e9MfZb3XRb+9k+FRPkJkQPmV7LQbcOegglLREWpe6TI0BgSmwiiN/Q09EpGicAIGwVI8BrP+mL6wcHdJl+rEXDxHlNyc8Pu3kqwHSXOje0KAmAQkj3dgoARMCYK7th4QN9cV4w+yGUCLrYHHrxvWNI6Jx/6EKWyUTp9PHUCBCJitq13zFZhqnsnAKAMKLs/BK8/lBffO8bQV02vbr+BB5/84jbVwP/UOXwyDQATlr4zIoup2UjchIAQR9hxtheeGzU+dnUTP5fnA/cu6AJYlXg4nZKlcM9SDywxCU+U8qNWGmskwAQS0JxDF17d28EfNk/A5tjKibMbcLew+6eCFJrooKCU6O3swZb69PmAhQnASDmAbdd0S05GRR6ZGvbvoxjXG0jxO6gmxtJGEvBSOwxBv/OzYoK3ZwEgJB/86WleHNKX5xfKmV1Vf3BBMa+dBA7G10OANDj5PYdwLS3nQbArcO7YdEkfSNAoQBA7AhSIBIV2aLjs8LaYQInASDmABOu7Y759/WBmBBmayKXcLzciD0u/wQAWErBSLQgcv+dBICY+E2rPB8/H63voPSD/yq4a36T6xNJxZ0BMQJsA3BpNlQ7/X8nAXBRzxK8/mAf3FRRqssNb248herXD+GE4uatwKQp2wUAvuziLV1dBttB5BQAxPA//prumHdvH3QPZB/+hS/EQdTza9y9E9gWswMCAK6HqZOrgGFlfvzxoT64coC+s4CTCuO+V5qwastX7j4LaEOAB4Auhi8R/JfuuhDfH6Zv6BesCuU0MG22B4AMAOh7noR7bjgPT97SE+L7b6SJHIRfrTpaEAmiwq6iBcC6egV/3doCTeeZrNjtC/X24cahQVSU+43EvJ32wNFWVMmN+HiPmlN/JzoVLQCccOazq4/h16tcnw10hms8AJiElA27Vdz7SlMhbP6cA4CiXAaaFFddbL482op7/tCE9TuVgpj5dzAquQwsyo0gXZEzgaj5Kw1TXjuMlZ8VxKWQsy3eXrRbwSbENisL8cuf/NohvLetoC6IttuV3gouysOgrNHLk+DvO1rw2J+OJItH6Fxo5CnRku5LyR/ZO5ugufZCSNpso1vBlrgLSNYE+OXKo3hjw0m35/xldUHyOLhYE0KyWm+AQPzC/7lLwfwPTuDtz7+CSP0uhkYiIaRYU8JyCZAo/bKzKZG8TtZ0ohWbYmrqL6q6PcEzF3ORSgnzkkJzcl4xdEomhQpDApGolxZeDBE1ZkMqLbwNAN7FEGPOKwbq0xdDvKthxRBPYzaceTXMuxxqzHvFQN3xcqh3PbwYImrMhjOuh7fNA7wCEcZ8WMjUZxaIEJa4/YKI0Z3AfCqEFHJk9eiesURMsRWJ8gDQORQyFolKfgaqo0fAuEAPiuym8UYAszzOR1V5UHuMz6oTGH0VQFEUivRGgM4AQwtVOZS5UGSwes9oZiqKUrEeADIDgKhkjFI3IHOpWNElWF0cxaI9AJwLgKzFotuWg0VRLt4DQMYRQE+5+P0VzImCfzDCA0CmEUDHgxHJUaAInozxAHAWAPQ+GZOcB7jw0ShvGZjfMtDQo1GpyWD0Q2Z0+uBgfuoY710iAYP7+tCvZwnENa6umsjoiR1J4H/NrYWcsGncSZ30IMY6Za6BZ+NSn4FoFQiLTdPCY+SgB6QqVR64NJMC3tOxDobFDtE5Px2bmgt4j0fbESQrZeT1eHRqX8B7Pt7KAFnLO8/n44Vy/sj+qwmJTdYq6nG3wgMM34i43H9zV7x1VT0KRKLPAnjaCiU9npZ5YJYqh5/Jxl0XAFDDUuBgdBuYhmVj6P3fBR4g2qH2G3gZZlDWK0z6AJA6JBrLzCtcYJ6nQhYPENEdSl1IVwFw3QBIzQeicwh42IuAez2QTvfWq6EhAKRWBdFPAIzQK8Cjs9UDm1Q5fI0RiYYB4J8au4403mBEiEdrjwdYouvjtaGPjUgzDIC2T8EkAuYZEeTRWusBBibH5fB8o1JyAkAKBHueJ9ATRgV69OZ7gMEvxOVBT+bCOWcAtM0HxGFRVS6CvT6meWCJKocn5MotLwCghn3BA7G1TO45Ns7VEYXYL3nMWx66GTMo57dp8gOAeMtn6u7yuFbyF4CvKEQnFq7OtMUfDI46OaesIR8b8gaAEB6cHBvCEq8GMDQfZby+uj1QTxpVKvNCO3X36ITQFAAkQVC9q4K5RNwp8ECQb1S67l9P1DpGqbvElLceTQPA6ZEAy7zPgVUIoC2kYZwZv/y0hqYCQDDt8UhDWaKlZYk3MTQXBGLC5yvRJpysHXzATM6mAyCpXA37Ag2xRd4S0bRQLVHLQhPzme13pok1AGiT5m0W5Q+AfDZ59Ei3FABCAX8k6m0b64lEBppct3eNiLMcAEkQpA6QZO8UUXdoNrFEEaMHO7q5dyC0BQBpeV4+QfYQGT3Pz86xawpbAZDaL4iNZeA5MHvpZR1jQ7yDID2lN5Mn38BbtgzUpZjIMWyIiWvoXqJpymGz1LLQdD05fLr8a4DI9hGgo26plPPWGoDvMKBzEZHSCkbJjGyp21Ya7CgA0oaJG0gApjEw0kpj3cJbXNcCMFORw46X43EFANKBCUT2jifWHi3WXUQirGMNc9S5YfFMjyuaqwBwekSI3cqsRUB0pyu8lK8SzMuJJFmRQ2vyZWV2f1cCoB0I1clyNfcT0YPMfJHZxlvJTxRkYuYFRL6FSl1/U07urNDX1QDoaHCwet9oZq0K0MYB1MsKZ+TNk9AMxnIiXqLUDWovxZY3XwsZFAwAzgDD1L2VmqZVEjAKwOUW+kcP660MvCtJ0mqldqBIiimoVpAA6OjhZKl78o9k4hsIuBbAVQC6WxSFUwA+ZWAjMX0kcXx9y7whMYtk2cK24AGQyUviISz4fRXQaKgGDhMwgIByBvoAyVrI5Z14V5y1NxNwiIEDDOyTQFFIXI944gtl/pAdtkTFRiH/B2Q8WOFlU6o/AAAAAElFTkSuQmCC">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Chat</title>

  <style>
    body {
      background: #efefef;
      height: 100%;
      font-family: Arial, Helvetica, sans-serif;

    }

    /* #center-text {          
  display: flex;
  flex: 1;
  flex-direction:column; 
  justify-content: center;
  align-items: center;  
  height:100%;
  
} */


    #chat-circle {
      position: fixed;
      bottom: 50px;
      right: 50px;
      background: #0668E1;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      color: white;
      padding: 28px;
      cursor: pointer;
      box-shadow: 0px 3px 16px 0px rgba(0, 0, 0, 0.6), 0 3px 1px -2px rgba(0, 0, 0, 0.2), 0 1px 5px 0 rgba(0, 0, 0, 0.12);
    }

    .btn#my-btn {
      background: white;
      padding-top: 13px;
      padding-bottom: 12px;
      border-radius: 45px;
      padding-right: 40px;
      padding-left: 40px;
      color: #0668E1;
    }

    #chat-overlay {
      background: rgba(255, 255, 255, 0.1);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: none;
    }




    .chat-box {
      display: none;
      background: #efefef;
      position: fixed;
      right: 30px;
      bottom: 50px;
      width: 800px;
      max-width: 85vw;
      max-height: 100vh;
      border-radius: 5px;
      box-shadow: 0px 5px 35px 9px #0668E1;
      box-shadow: 0px 5px 35px 9px #ccc;
    }

    #chatname {
      display: inline-block;
    }

    .chat-box-toggle {

      float: right;
      margin-right: 15px;
      cursor: pointer;
    }

    .right {
      flex: 1;
      background: #efefef;

    }

    .chat-box-header {

      background: #0668E1;
      height: 70px;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      color: white;
      text-align: center;
      font-size: 20px;
      padding-top: 17px;
      opacity: 1;
    }

    .chat-box-body {

      height: 370px;
      height: auto;
      border: 1px solid #ccc;
      overflow: hidden;

    }

    .whole {
      display: flex;

    }

    .left {

      width: 200px;

    }


    .chat-box-body:after {
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      content: "";
      position: absolute;
      z-index: -1;
      opacity: 0.1;

    }

    #chat-input {
      background: #f4f7f9;
      width: 100%;
      position: relative;
      height: 47px;
      padding-top: 10px;
      padding-right: 50px;
      padding-bottom: 10px;
      padding-left: 15px;
      border: none;
      resize: none;
      outline: none;
      border: 1px solid #ccc;
      color: #888;
      border-top: none;
      border-bottom-right-radius: 5px;
      border-bottom-left-radius: 5px;
      overflow: hidden;
    }

    .chat-input>form {
      margin-bottom: 0;
    }

    .chat-submit {
      position: absolute;
      bottom: 3px;
      right: 10px;
      background: transparent;
      box-shadow: none;
      border: none;
      border-radius: 50%;
      color: #0668E1;
      width: 35px;
      height: 35px;
    }

    .chat-logs {
      padding: 15px;
      height: 370px;
      overflow-y: scroll;
    }

    .chat-logs::-webkit-scrollbar-track {
      -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
      background-color: #F5F5F5;
    }

    .chat-logs::-webkit-scrollbar {
      width: 5px;
      background-color: #F5F5F5;
    }

    .chat-logs::-webkit-scrollbar-thumb {
      background-color: #0668E1;
    }



    @media only screen and (max-width: 500px) {
      .chat-logs {
        height: 40vh;
      }
    }

    .chat-msg.user>.msg-avatar img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      float: left;
      width: 15%;
    }

    .chat-msg.self>.msg-avatar img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      float: right;
      width: 15%;
    }

    .cm-msg-text {
      background: white;
      padding: 10px 15px 10px 15px;
      color: #666;
      max-width: 75%;
      float: left;
      margin-left: 10px;
      position: relative;
      margin-bottom: 20px;
      border-radius: 30px;
    }

    .chat-msg {
      clear: both;
    }

    .chat-msg.self>.cm-msg-text {
      float: right;

      background: #0668E1;
      color: white;
    }

    .cm-msg-button>ul>li {
      list-style: none;
      float: left;
      width: 50%;
    }

    .cm-msg-button {
      clear: both;
      margin-bottom: 70px;
    }

    button[type=chatroom-submit] {
      appearance: none;
      -webkit-appearance: none;
      padding: 10px;
      margin: 10px 50px;
      border: 0;
      box-shadow: 0 0 15px 4px rgba(0, 0, 0, 0.06);
      background-color: #0b994d;
      color: #fff;
      border-radius: 5px;
      position: absolute;

      bottom: 0;
      left: 0;

    }

    h1 {
      font-size: 20px;
      font-weight: 600;

    }
  </style>

</head>

<body>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
    var socket = io();
    var id = "";
    var activegc = [];

    var roomID;


    console.log(roomID);
    var INDEX = 0;

    window.onload = function () {
      getFriendsOnline();
      getChatRooms();
      getChatInvites();
    }

    function getChatRooms() {

      $(document).ready(function () {
        
        console.log("chatrooms!!");
        $.getJSON('/getchatrooms', function (elementsArr) {
          activegc = [];
          console.log("inside getjson chatroom")
          console.log(elementsArr);

          for (let i = 0; i < elementsArr.length; i++) {
            var Item =
            {
              "content": elementsArr[i].content,
              "chatID": elementsArr[i].chatID,
              "users": elementsArr[i].userIDs
            };
            console.log(elementsArr[i]);
            activegc.push(Item);
            console.log(Item);
          }
          console.log(activegc);
          for (let i = activegc.length - 1; i >= 0; i--) {
            createChatRoomButton(activegc[i])
          };


        });
      });
    }

    function getFriendsOnline() {
      var onlinefriends = [];
      $(document).ready(function () {
        console.log("friends online!!");
        $.getJSON('/getonlineusers', function (elementsArr) {
          console.log("here!!!");
          console.log(elementsArr);

          for (let i = 0; i < elementsArr.length; i++) {
            var Item =
            {
              "name": elementsArr[i]
            };
            console.log(elementsArr[i]);
            onlinefriends.push(Item);
            console.log(Item);
          }
          console.log(onlinefriends);
          for (let i = onlinefriends.length - 1; i >= 0; i--) {
            createOnlineFriendDiv(onlinefriends[i]);
          };


        });
      });
    }

    function getChatInvites() {
      $(document).ready(function () {
        console.log("chat invites!!");
        $.getJSON('/getUserInfo', function (data) {
          console.log(data);
          var invitesSet = data.invites.SS
          console.log(invitesSet);
          var chatInviteList =[];
          invitesSet.forEach(inv => chatInviteList.push(inv));
          for (let i = chatInviteList.length - 1; i >= 0; i--) {
            if(chatInviteList[i]!==""){
              createChatInviteDiv(chatInviteList[i]);
            }
            
          };
         
        });
      });
    }

    function createChatInviteDiv(chatinvite) {
      test_el = document.createElement('div');

      test_el.innerHTML =
        '<div class="onlinefriend"><div class= "chatInviteID">'
        + chatinvite +
        '</div>';
   
      var acceptID = "accept-invite-button-" + chatinvite
      test_el.innerHTML +=
        '<button type = "accept" id = ' + acceptID + '>accept</button></div>'

        var rejectID = "reject-invite-button-" + chatinvite
      test_el.innerHTML +=
        '<button type = "reject" id = ' + rejectID + '>reject</button></div>'
      document.body.appendChild(test_el);

      var onlineFriendsDiv = document.getElementById('chatinvites');
      onlineFriendsDiv.after(test_el);
      var acceptIDWithHash = "#" + acceptID;
      var rejectIDWithHash = "#" + rejectID;
     acceptButtons( acceptIDWithHash , chatinvite);
     rejectButtons(rejectIDWithHash, chatinvite);
    }

    function rejectButtons(acceptID, chatInvite) {
      $(document).ready(function () {
        $(acceptID).click(function (e) {
            console.log("reject clicked!");
            e.preventDefault();

                    $.ajax({
                      type: "POST",
                      url: "/rejectinvite",
                      data:{ 
                          chatID : chatInvite
                      },

                    success: function(result) {
                    alert('rejectedInvite');
                    console.log(result);

                    },
                error: function(result) {
                    alert('error');
                }
            });
        


        });

      });
    }

    function acceptButtons(acceptID, chatInvite) {
      $(document).ready(function () {
        $(acceptID).click(function (e) {
            console.log("accept clicked!");
            e.preventDefault();

                    $.ajax({
                      type: "POST",
                      url: "/acceptinvite",
                      data:{ 
                          chatID : chatInvite
                      },

                    success: function(result) {
                    alert('Accepted Invite');
                    console.log(result);

                    },
                error: function(result) {
                    alert('error');
                }
            });
        


        });

      });
    }
  

    function createOnlineFriendDiv(onlinefriend) {
      test_el = document.createElement('div');

      console.log("online friend: ");

      var onlinefriendname = onlinefriend.name.S;
      test_el.innerHTML =
        '<div class="onlinefriend"><div class= "user">'
        + onlinefriendname +
        '</div>';
      console.log(onlinefriendname);
      var inviteID = "invite-button-" + onlinefriendname
      test_el.innerHTML +=
        '<button type = "invite" id = ' + inviteID + '>invite</button></div>'
      document.body.appendChild(test_el);
      var onlineFriendsDiv = document.getElementById('online-friends');
      onlineFriendsDiv.after(test_el);
      var inviteIDWithHash = "#" + inviteID;
      inviteButtons(inviteIDWithHash, onlinefriendname);
    }

    function inviteButtons(inviteID, onlinefriend) {
      $(document).ready(function () {
        $(inviteID).click(function (e) {
          if (roomID != undefined) {
            console.log("invite clicked!");
            console.log(roomID);
            console.log(onlinefriend);
            e.preventDefault();

                    $.ajax({
                      type: "POST",
                      url: "/inviteuser",
                      data:{ 
                          chatID : roomID,
                          invitedUser: onlinefriend,
                      },

                    success: function(result) {
                    alert('added');
                    console.log(result);

                    },
                error: function(result) {
                    alert('error');
                }
            });
          }
          else {
            alert("select a chatroom first");
          }


        });

      });
    }






    function sendChat() {
      console.log("send chat");
      console.log(roomID);
      if ($('#chat-input').val().trim() !== '') {
        console.log(roomID);
        var mes = $('#chat-input').val().trim()
        var messageItem = {
          text: mes,
          sender: id,
          room: roomID,

        }

        socket.emit("chat message", messageItem);
        console.log("emitted");


        $('#chat-input').val('');
        $('#chat-input').focus();

        $.ajax({
          type: "POST",
          url: "/addmessage",
          data: {
            chatID : roomID,
            message :mes
          },
          success: function (result) {
            console.log("message added!!!!");
          },
          error: function (result) {
            console.log(result);
            alert('error');
          }
        });
      }
    }

    $(document).ready(function () {
      $.getJSON('/getCreator', function (creator) {
        id = creator;
        console.log(id);
        $("#currUser").html(id);
      });

    });

    $(document).ready(function () {
      socket.emit("join room", {
        sender: id,
        room: roomID
      });
    });

    function generate_message(msg, type, sender) {

      console.log(msg);
      INDEX++;
      var str = "";
      if (id == sender) {
        str += "<div id='cm-msg-" + INDEX + "' class=\"chat-msg " + type + "\">";
        str += "          <div class=\"cm-msg-text\">";
        str += msg;
        str += "          <\/div>";
        str += "        <\/div>";
      }
      else {
        str += "<div id='cm-msg-" + INDEX + "' class=\"chat-msg " + type + "\">";
        str += "          <span class=\"sender\">";
        str += "          <div class=\"cm-msg-sender\">";
        str += sender;
        str += "          <\/div>";
        str += "          <\/span>";
        str += "          <div class=\"cm-msg-text\">";
        str += msg;
        str += "          <\/div>";
        str += "        <\/div>";
      }

      $(".chat-logs").append(str);
      $("#cm-msg-" + INDEX).hide().fadeIn(300);
      if (type == 'self') {
        $("#chat-input").val('');
      }
      $(".chat-logs").stop().animate({ scrollTop: $(".chat-logs")[0].scrollHeight }, 1000);
    }







    // Called whenever a chat is sent, emits to socket and posts to the database
    $(document).ready(function () {
      console.log("here");
      console.log(roomID);

      socket.on("chat message", function (msg) {
        console.log("in chat message")
        console.log(msg);
        var message_temp = document.createElement("li");
        var text = msg.text;

        if (id == msg.sender) {
          generate_message(text, 'self', id);

        } else {
          generate_message(text, 'user', msg.sender);

        }

      });

      $("#chat-circle").click(function () {
        $("#chat-circle").toggle('scale');
        $(".chat-box").toggle('scale');
      })

      $(".chat-box-toggle").click(function () {
        $("#chat-circle").toggle('scale');
        $(".chat-box").toggle('scale');
      })



    })

  </script>

  <script>

    $(document).ready(function () {
      var input = document.getElementById("chat-input");
      input.addEventListener("keypress", function (e) {
        if (e.keyCode === 13) {
          event.preventDefault();  //checks whether the pressed key is "Enter"
          sendChat();
        }
      });
    })

  </script>

  <script>
    $(document).ready(function () {
      $("#chatroom-submit").click(function (e) {
        console.log("chatroom create!");
        e.preventDefault();

        $.ajax({
          type: "POST",
          url: "/addchatroom",
          data: {
            username: id
          },
          success: function (result) {
            console.log("chatroom!!!!");
            var Item =
            {
              "content": result.content,
              "chatID": result.chatID,
              "users": result.userIDs
            };
            console.log(Item);
            createChatRoomButton(Item);
          },
          error: function (result) {
            console.log(result);
            alert('error');
          }
        });

 
           
        

      });

    });



    function createChatRoomButton(chatroom) {
      console.log("create chatroom button")
      test_el = document.createElement('div');
      var chatName = "";
      var usersArr1 = [];
      var usersArr = [];
      console.log(chatroom.users);
      var usersArr = (chatroom.users).SS;
      console.log(usersArr);

      for (let i = 0; i < usersArr.length; i++) {
        console.log(usersArr[i]);
        chatName += usersArr[i] + " ";
      }
      console.log(chatName);


      var gcID = "gc-button-" + chatroom.chatID.S
      test_el.innerHTML +=
        '<button type = "gc" id = ' + gcID + '>' + chatName + '</button></div>'
      document.body.appendChild(test_el);
      var gcDiv = document.getElementById('chatrooms');
      gcDiv.after(test_el);
      gcButtons(gcID, chatName, chatroom.chatID.S);
    }

    function updateChatMessages(gcID, chatName, chatID){
      $(document).ready(function () {
        activegc = [];
        console.log("chatrooms!!");
        $.getJSON('/getchatrooms', function (elementsArr) {
          console.log("inside chat message update")
          console.log(elementsArr);

          for (let i = 0; i < elementsArr.length; i++) {
            var Item =
            {
              "content": elementsArr[i].content,
              "chatID": elementsArr[i].chatID,
              "users": elementsArr[i].userIDs
            };
            console.log(elementsArr[i]);
            activegc.push(Item);
            console.log(Item);
          }
          console.log(activegc);
          gcButtonFunction(gcID, chatName, chatID);
     
        });
      });
    }
    function gcButtons(gcID, chatName, chatID) {
      INDEX = 0;
      var gcIDWithHash = "#" + gcID;
     
      $(document).ready(function () {
        
        $(gcIDWithHash).click(function (e) {
          updateChatMessages(gcID, chatName, chatID);
        
          console.log("gc clicked!");
          document.getElementById("chat-logs").innerHTML = "";
          e.preventDefault();
         

        });

      });


    }

    function gcButtonFunction(gcID, chatName, chatID){
      socket.emit("leave room", {
            sender: id,
            room: roomID
          });
          console.log(chatID);
          $("#chatname").html(chatID);
          roomID = chatID;
          console.log("room id is now: ")
          console.log(roomID);
          socket.emit("join room", {
            sender: id,
            room: roomID
          });
          console.log(activegc);
          
          var roomSelected;
          for (let i = 0; i < activegc.length; i++) {
            if (activegc[i].chatID.S == roomID) {
              roomSelected = activegc[i];
            }
          }
          console.log(roomSelected);
          var contentArray = [];
          console.log("contentarray: ")
          contentArray = roomSelected.content.L
          console.log(contentArray);
          for (let i = 0; i < contentArray.length; i++) {
            var user = contentArray[i].L[0].S;
            var text = contentArray[i].L[1].S;
            if (user == id) {
              generate_message(text, 'self', id);
            }
            else {
              generate_message(text, 'user', user);
            }


          }
    }
  </script>







  <main>




    <div id="body">


      <div id="chat-circle" class="btn btn-raised">
        <div id="chat-overlay"></div>
        <img src="https://img.icons8.com/material-rounded/24/FFFFFF/communication.png" />
      </div>

      <div class="chat-box">


        <div class="whole">
          <div class="left">
            <div id="online-friends">
              <h1> online friends</h1>
            </div>

            <div id="chatrooms">
              <h1> active chatrooms</h1>
            </div>

            <div id="chatinvites">
              <h1> chat invites</h1>
            </div>

            <button type="chatroom-submit" class="chatroom-submit" id="chatroom-submit">
              add new chat
            </button>
          </div>

          <div class="right">
            <div class="chat-box-header">
              <div id="chatname">
                chat
              </div>
              <span class="chat-box-toggle">
                <img src="https://img.icons8.com/material-outlined/24/FFFFFF/cancel--v1.png" />
              </span>
            </div>
            <div class=right-chatbox>
              <div class="chat-box-body">
                <div class="chat-box-overlay">
                </div>
                <div class="chat-logs" id="chat-logs">

                </div>
              </div>

            </div>
            <div class="chat-input">

              <div>
                <ul id="messages">
                </ul>
              </div>

            </div>
            <input class="text" id="chat-input" autocomplete="off" placeholder="type a message..."
              onfocus="this.placeholder=''" onblur="this.placeholder='type a message...'">


            <button type="submit" class="chat-submit" id="chat-submit" onclick=sendChat()>
              <img src="https://img.icons8.com/material/24/0668E1/filled-sent.png" />
            </button>
          </div>



        </div>
      </div>

    </div>



    </div>



  </main>
</body>

</html>